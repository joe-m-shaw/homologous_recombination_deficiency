---
title: "INC9110 Investigation"
author: "Joe Shaw"
date: today
date-format: "DD/MM/YYYY"
format: html
---

Code to produce this Quarto is saved in my [Github repo](https://github.com/joeshaw824/homologous_recombination_deficiency/tree/qiasymphony_validation)

## Introduction

The SeqOne SomaHRD pipeline has been validated for homologous recombination deficiency (HRD) testing in ovarian cancer.

In December 2023, SomaHRD v1.2 was validated for clinical use.

It recently came to our attention that since the clinical service has gone live, the patch number of SomaHRD had changed without being communicated. 

The pipeline version in December 2023 was version 1.2.1, whereas in April 2024 the version in use is version 1.2.7.

```{r}
#| label: packages-and-functions
#| include: false

library("tidyverse")
library("ggpubr")
library("readxl")
library("here")
library("patchwork")
library("rvest")

source(here::here("functions/hrd_functions.R"))

```

I selected 10 samples from the validation cohort and reran them through SomaHRD v1.2.7 to check for any differences in the PDF reports produced.

I am using PDF reports as the data source because when the method was validated only PDFs were available for download from the SeqOne website, although csv files are now provided with new analyses.

```{r}
#| label: load-validation-data
#| include: FALSE

seqone_report_files_v1_2 <- list.files(here::here("data/seqone_reports_v1_2/"),
  full.names = TRUE
)

validation_data <- seqone_report_files_v1_2 |>
  map(\(seqone_report_files_v1_2) read_seqone_report(
    file = seqone_report_files_v1_2,
    version = "1.2"
  )) |>
  list_rbind()

```

```{r}
#| label: load-rerun-pdf-files
#| include: FALSE
#| warning: FALSE

somahrd_v1_2_7_pdfs <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".pdf")

somahrd_v1_2_7_pdf_data <- somahrd_v1_2_7_pdfs |> 
  map(\(somahrd_v1_2_7_pdfs) read_seqone_report(somahrd_v1_2_7_pdfs, version = "1.2")) |> 
  list_rbind() |> 
  arrange(shallow_sample_id)

```

```{r}
#| label: load-csvs-html
#| include: FALSE
#| eval: FALSE

somahrd_v1_2_7_csvs <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".csv")

somahrd_v1_2_7_csv_data <- somahrd_v1_2_7_csvs |> 
  map(\(somahrd_v1_2_7_csvs) read_seqone_csv(somahrd_v1_2_7_csvs)) |> 
  list_rbind()

somahrd_v1_2_7_html <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".html")

somahrd_v1_2_7_html_data <- somahrd_v1_2_7_html |> 
  map(\(somahrd_v1_2_7_html) parse_seqone_html(somahrd_v1_2_7_html)) |> 
  list_rbind()

somahrd_v1_2_7_html_wide <- somahrd_v1_2_7_html_data |> 
  pivot_wider(id_cols = c(worksheet, sample_id),
              names_from = name,
              values_from = version)

```

## Comparison

When the results from the PDF reports generated by the two pipeline versions are compared, there are no changes in SeqOne HRD score or SeqOne HRD status. 

This table shows the results arranged by the sample ID and the date.

```{r}
#| label: compare-results
#| echo: FALSE

results_from_validation <- validation_data |> 
          filter(shallow_sample_id %in% somahrd_v1_2_7_pdf_data$shallow_sample_id) |> 
  arrange(shallow_sample_id)

comparison <- somahrd_v1_2_7_pdf_data |> 
  rbind(results_from_validation) |> 
  select(-c(worksheet, sample_id, dlms_dna_number, seqone_ncc, user, filename, version)) |>
  arrange(shallow_sample_id, date) |> 
  relocate(date)

knitr::kable(comparison)

```

All the other fields I'd expect to be the same are the same, except for robustness (user, date and filename differ but that is expected).

```{r}
#| label: check-results
#| include: TRUE

all.equal(somahrd_v1_2_7_pdf_data, results_from_validation)

```

## Confidence in Genomic Instability (Robustness)

In 7/10 samples, confidence in genomic instability (previously called robustness) varies between the two pipeline versions, ranging from +0.07 to -0.12.

This variation did not change the overall HRD status to or from "NON-CONCLUSIVE" in any sample.

```{r}
#| label: compare-robustness
#| echo: FALSE
#| include: TRUE

robustness_comp_table <- comparison |> 
  mutate(somahrd_version = ifelse(date == "2024-04-10", "v1.2.7", "v1.2.1")) |> 
  select(shallow_sample_id, somahrd_version, robustness) |> 
  pivot_wider(id_cols = c(shallow_sample_id),
              names_from = somahrd_version,
              values_from = robustness) |>  
  mutate(robustness_diff = `v1.2.7` - `v1.2.1`) |> 
  arrange(desc(robustness_diff)) |> 
  select(shallow_sample_id, `v1.2.1`, `v1.2.7`, robustness_diff)

knitr::kable(robustness_comp_table)

```

## Could This Impact the Validation?

If we assume that the robustness value can change from +0.07 to -0.12 when samples are analysed by different pipeline versions, then we can predict how many samples could be impacted in the full validation cohort.

On the basis of this, a third of samples could have a change in overall status from a conclusive result to non-conclusive, or vice versa.

```{r}
#| label: potential-impact
#| echo: FALSE

robustness_threshold <- 0.85

robustness_upper <- robustness_threshold + 0.12

robustness_lower <- robustness_threshold - 0.07

validation_data_mod <- validation_data |> 
  mutate(impact = ifelse(robustness <= robustness_upper &
                           robustness >= robustness_lower,
         "status changed", "status not changed")) 

ggplot(validation_data_mod, aes(x = reorder(shallow_sample_id, robustness),
                            y = robustness)) +
  geom_point(pch = 21, aes(fill = impact)) +
  scale_fill_manual(values = c(safe_red, safe_blue)) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  geom_hline(yintercept = 0.85) +
  geom_hline(yintercept = robustness_upper, linetype = "dashed") +
  geom_hline(yintercept = robustness_lower, linetype = "dashed") +
  labs(y = "Robustness", x = "Sample",
       title = "Results generated by SomaHRD v1.2.1",
       subtitle = "Changing to SomaHRD v1.2.7 could change conclusive/non-conclusive status",
       caption = "Dashed lines show variation in robustness calculated for 10 samples analysed by v1.2.1 and v1.2.7") +
  scale_y_continuous(breaks = c(0.6, 0.7, 0.8, 0.85, 0.9, 1.0)) +
  geom_text(aes(x = 80, y = 0.87), label = "Conclusive") +
  geom_text(aes(x = 80, y = 0.83), label = "Not conclusive")

```

```{r}
#| label: extra-plot
#| eval: FALSE
#| include: FALSE

comparison |> 
  mutate(somahrd_version = ifelse(date == "2024-04-10", "v1.2.7", "v1.2.1")) |>
  ggplot(aes(x = reorder(shallow_sample_id, robustness), y = robustness)) +
  geom_point(pch = 21, size = 3, aes(fill = somahrd_version)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  geom_hline(yintercept = robustness_threshold) +
  geom_text(aes(x = 7, y = 0.87), label = "Conclusive") +
  geom_text(aes(x = 7, y = 0.83), label = "Not conclusive") +
  labs(x = "")

```

## Could this impact the clinical service?

Here is the data from the clinical service so far, with the same variation interval around the confidence in genomic instability threshold.

```{r}
#| label: potential-impact-live-service
#| echo: FALSE

live_ws_excel <- read_excel(path = here::here("data/live_service_worksheets.xlsx"))

live_ws <- list(live_ws_excel$worksheet)

live_ws_filepaths_pdf <- live_ws |> 
  map(\(live_ws) find_hrd_files(live_ws, filetype = ".pdf")) |> 
  flatten()

live_data_pdf <- live_ws_filepaths_pdf |>
  map(\(live_ws_filepaths_pdf) read_seqone_report(
    file = live_ws_filepaths_pdf,
    version = "1.2"
  )) |>
  list_rbind()

ggplot(live_data_pdf, aes(x = reorder(shallow_sample_id, robustness),
                            y = robustness)) +
  geom_point(pch = 21) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  geom_hline(yintercept = 0.85) +
  geom_hline(yintercept = robustness_upper, linetype = "dashed") +
  geom_hline(yintercept = robustness_lower, linetype = "dashed") +
  labs(title = "HRD Service Results")


```

```{r}


```
