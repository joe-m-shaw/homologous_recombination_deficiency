---
title: "INC9110 Investigation"
author: "Joe Shaw"
date: today
date-format: "DD/MM/YYYY"
format: html
---

Code to produce this Quarto is saved in my [Github repo](https://github.com/joeshaw824/homologous_recombination_deficiency/tree/qiasymphony_validation)

## Introduction

The SeqOne SomaHRD pipeline has been validated for homologous recombination deficiency (HRD) testing in ovarian cancer.

In December 2023, SomaHRD v1.2 was validated for clinical use.

It recently came to our attention that since the clinical service has gone live, the patch number of SomaHRD had changed without being communicated. 

The pipeline version in December 2023 was version 1.2.1, whereas in April 2024 the version in use is version 1.2.7.

```{r}
#| label: packages-and-functions
#| include: false

library("tidyverse")
library("ggpubr")
library("readxl")
library("here")
library("patchwork")
library("rvest")

source(here::here("functions/hrd_functions.R"))

```

I selected 10 samples from the validation cohort and reran them through SomaHRD v1.2.7 to check for any differences in the PDF reports produced.

I am using PDF reports as the data source because when the method was validated only PDFs were available for download from the SeqOne website, although csv files are now provided with new analyses.

```{r}
#| label: load-validation-data
#| include: FALSE

seqone_report_files_v1_2 <- list.files(here::here("data/seqone_reports_v1_2/"),
  full.names = TRUE
)

validation_data <- seqone_report_files_v1_2 |>
  map(\(seqone_report_files_v1_2) read_seqone_report(
    file = seqone_report_files_v1_2,
    version = "1.2"
  )) |>
  list_rbind()

```

```{r}
#| label: load-rerun-pdf-files
#| include: FALSE
#| warning: FALSE

somahrd_v1_2_7_pdfs <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".pdf")

somahrd_v1_2_7_pdf_data <- somahrd_v1_2_7_pdfs |> 
  map(\(somahrd_v1_2_7_pdfs) read_seqone_report(somahrd_v1_2_7_pdfs, version = "1.2")) |> 
  list_rbind() |> 
  arrange(shallow_sample_id)

```

```{r}
#| label: load-csvs-html
#| include: FALSE
#| eval: FALSE

somahrd_v1_2_7_csvs <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".csv")

somahrd_v1_2_7_csv_data <- somahrd_v1_2_7_csvs |> 
  map(\(somahrd_v1_2_7_csvs) read_seqone_csv(somahrd_v1_2_7_csvs)) |> 
  list_rbind()

somahrd_v1_2_7_html <- list.files(path = here::here("data/INC9110_files/"),
                              full.names = TRUE, pattern = ".html")

somahrd_v1_2_7_html_data <- somahrd_v1_2_7_html |> 
  map(\(somahrd_v1_2_7_html) parse_seqone_html(somahrd_v1_2_7_html)) |> 
  list_rbind()

somahrd_v1_2_7_html_wide <- somahrd_v1_2_7_html_data |> 
  pivot_wider(id_cols = c(worksheet, sample_id),
              names_from = name,
              values_from = version)

```

## Comparison

When the results from the PDF reports generated by the two pipeline versions are compared, there are no changes in SeqOne HRD score or SeqOne HRD status. 

This table shows the results arranged by the sample ID and the date.

```{r}
#| label: compare-results
#| echo: FALSE

results_from_validation <- validation_data |> 
          filter(shallow_sample_id %in% somahrd_v1_2_7_pdf_data$shallow_sample_id) |> 
  arrange(shallow_sample_id)

comparison <- somahrd_v1_2_7_pdf_data |> 
  rbind(results_from_validation) |> 
  select(-c(worksheet, sample_id, dlms_dna_number, seqone_ncc, user, filename, version)) |>
  arrange(shallow_sample_id, date) |> 
  relocate(date)

knitr::kable(comparison)

```

All the other fields I'd expect to be the same are the same, except for robustness (user, date and filename differ but that is expected).

```{r}
#| label: check-results
#| include: TRUE
#| echo: FALSE

all.equal(somahrd_v1_2_7_pdf_data, results_from_validation)

```

## Confidence in Genomic Instability (Robustness)

In 7/10 samples, confidence in genomic instability (previously called robustness) varies between the two pipeline versions, ranging from +0.07 to -0.12.

This variation did not change the overall HRD status to or from "NON-CONCLUSIVE" in any sample.

```{r}
#| label: compare-robustness
#| echo: FALSE
#| include: TRUE

robustness_comp_table <- comparison |> 
  mutate(somahrd_version = ifelse(date == "2024-04-10", "v1.2.7", "v1.2.1")) |> 
  select(shallow_sample_id, somahrd_version, robustness) |> 
  pivot_wider(id_cols = c(shallow_sample_id),
              names_from = somahrd_version,
              values_from = robustness) |>  
  mutate(robustness_diff = `v1.2.7` - `v1.2.1`) |> 
  arrange(desc(robustness_diff)) |> 
  select(shallow_sample_id, `v1.2.1`, `v1.2.7`, robustness_diff)

knitr::kable(robustness_comp_table)

```